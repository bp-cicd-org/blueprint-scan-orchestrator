# Blueprint Scan Orchestrator - Scan All Repositories
#
# This workflow orchestrates NIM scanning across all configured repositories.
# It triggers scans, waits for completion, collects results, and generates
# an aggregated report.

name: Scan All Repositories

on:
  # Schedule: Run weekly on Sunday at midnight UTC
  # Uncomment to enable scheduled runs
  # schedule:
  #   - cron: '0 0 * * 0'

  # Manual trigger
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run - print what would be done without triggering'
        required: false
        type: boolean
        default: false
      specific_repos:
        description: 'Specific repositories to scan (comma-separated, empty for all)'
        required: false
        type: string
        default: ''
      skip_wait:
        description: 'Skip waiting for workflows to complete'
        required: false
        type: boolean
        default: false
      timeout_minutes:
        description: 'Timeout for waiting on workflow completion (minutes)'
        required: false
        type: number
        default: 60

env:
  PYTHON_VERSION: '3.11'

jobs:
  # =============================================================================
  # Job 1: Trigger scan workflows in all target repositories
  # =============================================================================
  trigger:
    name: Trigger Scans
    runs-on: ubuntu-latest
    outputs:
      triggered: ${{ steps.trigger.outputs.triggered }}
    steps:
      - name: Checkout orchestrator
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Trigger scan workflows
        id: trigger
        env:
          GITHUB_TOKEN: ${{ secrets.SCAN_TRIGGER_TOKEN }}
        run: |
          python scripts/trigger_scans.py \
            --config config/repos.yaml \
            --output triggered-runs.json \
            ${{ inputs.dry_run && '--dry-run' || '' }} \
            ${{ inputs.specific_repos && format('--specific-repos "{0}"', inputs.specific_repos) || '' }}
          
          if [ -f triggered-runs.json ]; then
            echo "triggered=true" >> $GITHUB_OUTPUT
          else
            echo "triggered=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload triggered runs info
        uses: actions/upload-artifact@v4
        with:
          name: triggered-runs
          path: triggered-runs.json
          retention-days: 7

  # =============================================================================
  # Job 2: Wait for completion and collect reports
  # =============================================================================
  collect:
    name: Collect Reports
    runs-on: ubuntu-latest
    needs: trigger
    if: ${{ needs.trigger.outputs.triggered == 'true' && !inputs.dry_run }}
    steps:
      - name: Checkout orchestrator
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Download triggered runs info
        uses: actions/download-artifact@v4
        with:
          name: triggered-runs
          path: .

      - name: Collect reports
        env:
          GITHUB_TOKEN: ${{ secrets.SCAN_TRIGGER_TOKEN }}
        run: |
          python scripts/collect_reports.py \
            --runs-file triggered-runs.json \
            --output-dir reports \
            --timeout ${{ inputs.timeout_minutes || 60 }} \
            --poll-interval 30 \
            ${{ inputs.skip_wait && '--skip-wait' || '' }}

      - name: Upload collected reports
        uses: actions/upload-artifact@v4
        with:
          name: collected-reports
          path: reports/
          retention-days: 30

  # =============================================================================
  # Job 3: Aggregate all reports
  # =============================================================================
  aggregate:
    name: Aggregate Reports
    runs-on: ubuntu-latest
    needs: collect
    steps:
      - name: Checkout orchestrator
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Download collected reports
        uses: actions/download-artifact@v4
        with:
          name: collected-reports
          path: reports

      - name: Aggregate reports
        run: |
          python scripts/aggregate_reports.py \
            --reports-dir reports \
            --output aggregated-report.json \
            --markdown-output aggregated-report.md

      - name: Upload aggregated report
        uses: actions/upload-artifact@v4
        with:
          name: aggregated-report
          path: |
            aggregated-report.json
            aggregated-report.md
          retention-days: 90

      - name: Display summary
        run: |
          echo "========================================="
          echo "NIM Scan Aggregated Report"
          echo "========================================="
          cat aggregated-report.json | python -m json.tool
          echo ""
          echo "========================================="
          echo "Markdown Summary"
          echo "========================================="
          cat aggregated-report.md

  # =============================================================================
  # Job 4: Notify (optional)
  # =============================================================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: aggregate
    if: always()
    steps:
      - name: Download aggregated report
        uses: actions/download-artifact@v4
        with:
          name: aggregated-report
          path: .
        continue-on-error: true

      - name: Create summary
        run: |
          echo "## NIM Scan Orchestrator Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f aggregated-report.md ]; then
            cat aggregated-report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "No aggregated report available." >> $GITHUB_STEP_SUMMARY
          fi

      # Uncomment to enable Slack notification
      # - name: Send Slack notification
      #   if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     payload: |
      #       {
      #         "text": "NIM Scan completed. Check the workflow for details."
      #       }
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
